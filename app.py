{
 "cells": [
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "c5183177-0cec-4c78-9f4d-1313e622251e",
   "metadata": {},
   "outputs": [],
   "source": [
    "import streamlit as st\n",
    "import joblib\n",
    "import pandas as pd\n",
    "import shap\n",
    "import matplotlib.pyplot as plt\n",
    "from matplotlib.backends.backend_agg import FigureCanvasAgg\n",
    "import plotly.express as px\n",
    "\n",
    "# é…ç½®é¡µé¢\n",
    "st.set_page_config(\n",
    "    page_title=\"AKIé£é™©é¢„æµ‹ç³»ç»Ÿ\",\n",
    "    page_icon=\"ğŸ¥\",\n",
    "    layout=\"wide\"\n",
    ")\n",
    "\n",
    "# è‡ªå®šä¹‰æ ·å¼\n",
    "def local_css(file_name):\n",
    "    with open(file_name) as f:\n",
    "        st.markdown(f\"<style>{f.read()}</style>\", unsafe_allow_html=True)\n",
    "local_css(\"assets/style.css\")  # å¯é€‰\n",
    "\n",
    "# åŠ è½½æ¨¡å‹\n",
    "@st.cache_resource\n",
    "def load_model():\n",
    "    model = joblib.load('model/best_model.pkl')\n",
    "    features = joblib.load('model/feature_names.pkl')\n",
    "    return model, features\n",
    "\n",
    "model, feature_names = load_model()\n",
    "\n",
    "# ä¾§è¾¹æ  - è¾“å…¥è¡¨å•\n",
    "st.sidebar.header(\"æ‚£è€…å‚æ•°è¾“å…¥\")\n",
    "input_data = {}\n",
    "for feat in feature_names:\n",
    "    if feat in ['enhanced', 'symptom', 'edema']:  # åˆ†ç±»ç‰¹å¾\n",
    "        input_data[feat] = st.sidebar.selectbox(\n",
    "            f\"{feat} (æ˜¯å¦)\", \n",
    "            options=[0, 1],\n",
    "            format_func=lambda x: \"æ˜¯\" if x == 1 else \"å¦\"\n",
    "        )\n",
    "    else:  # æ•°å€¼ç‰¹å¾\n",
    "        input_data[feat] = st.sidebar.number_input(\n",
    "            feat, \n",
    "            min_value=0.0,\n",
    "            max_value=120.0 if feat == 'age' else 1000.0,\n",
    "            value=50.0 if feat == 'age' else 0.5\n",
    "        )\n",
    "\n",
    "# ä¸»ç•Œé¢\n",
    "st.title(\"æ€¥æ€§è‚¾æŸä¼¤(AKI)é£é™©è¯„ä¼°ç³»ç»Ÿ\")\n",
    "st.image(\"assets/hospital_logo.png\", width=200)\n",
    "\n",
    "# é¢„æµ‹æŒ‰é’®\n",
    "if st.sidebar.button(\"é£é™©è¯„ä¼°\", type=\"primary\"):\n",
    "    # è½¬æ¢ä¸ºDataFrame\n",
    "    input_df = pd.DataFrame([input_data])[feature_names]\n",
    "    \n",
    "    # é¢„æµ‹\n",
    "    proba = model.predict_proba(input_df)[0][1]\n",
    "    risk_level = \"é«˜é£é™©\" if proba > 0.5 else \"ä½é£é™©\"\n",
    "    \n",
    "    # æ˜¾ç¤ºç»“æœ\n",
    "    col1, col2 = st.columns(2)\n",
    "    with col1:\n",
    "        st.subheader(\"é¢„æµ‹ç»“æœ\")\n",
    "        st.metric(\"AKIæ¦‚ç‡\", f\"{proba*100:.1f}%\", delta_color=\"inverse\")\n",
    "        st.write(f\"**é£é™©ç­‰çº§**: :{'red' if risk_level == 'é«˜é£é™©' else 'green'}[{risk_level}]\")\n",
    "        \n",
    "        # ä¸´åºŠå»ºè®®\n",
    "        st.subheader(\"ä¸´åºŠå»ºè®®\")\n",
    "        if proba > 0.7:\n",
    "            st.warning(\"\"\"\n",
    "            - ç«‹å³å¤æŸ¥è¡€æ¸…è‚Œé…\n",
    "            - ç›‘æµ‹å°¿é‡æ¯å°æ—¶\n",
    "            - é¿å…è‚¾æ¯’æ€§è¯ç‰©\n",
    "            \"\"\")\n",
    "        elif proba > 0.3:\n",
    "            st.info(\"\"\"\n",
    "            - 6å°æ—¶å†…å¤æŸ¥è‚¾åŠŸèƒ½\n",
    "            - è¯„ä¼°å®¹é‡çŠ¶æ€\n",
    "            \"\"\")\n",
    "        else:\n",
    "            st.success(\"å¸¸è§„ç›‘æµ‹å³å¯\")\n",
    "    \n",
    "    with col2:\n",
    "        # SHAPè§£é‡Š\n",
    "        st.subheader(\"é£é™©å› ç´ åˆ†æ\")\n",
    "        \n",
    "        # è®¡ç®—SHAPå€¼\n",
    "        explainer = shap.TreeExplainer(model)\n",
    "        shap_values = explainer.shap_values(input_df)\n",
    "        \n",
    "        # åŠ¨æ€é€‰æ‹©è§£é‡Šå›¾è¡¨\n",
    "        tab1, tab2, tab3 = st.tabs([\"ç‰¹å¾è´¡çŒ®\", \"å†³ç­–è·¯å¾„\", \"è¯¦ç»†åˆ†è§£\"])\n",
    "        \n",
    "        with tab1:\n",
    "            fig, ax = plt.subplots()\n",
    "            shap.plots._waterfall.waterfall_legacy(\n",
    "                explainer.expected_value[1], \n",
    "                shap_values[1][0], \n",
    "                feature_names=feature_names,\n",
    "                show=False\n",
    "            )\n",
    "            st.pyplot(fig)\n",
    "        \n",
    "        with tab2:\n",
    "            fig, ax = plt.subplots()\n",
    "            shap.decision_plot(\n",
    "                explainer.expected_value[1], \n",
    "                shap_values[1][0:1], \n",
    "                feature_names=feature_names,\n",
    "                show=False\n",
    "            )\n",
    "            st.pyplot(fig)\n",
    "        \n",
    "        with tab3:\n",
    "            st.write(\"\"\"\n",
    "            | ç‰¹å¾        | å€¼    | è´¡çŒ®åº¦ |\n",
    "            |------------|-------|-------|\n",
    "            | age        | {:.1f} | {:.3f} |\n",
    "            | diameter   | {:.1f} | {:.3f} |\n",
    "            | ...        | ...   | ...   |\n",
    "            \"\"\".format(\n",
    "                input_df.iloc[0]['age'], shap_values[1][0][0],\n",
    "                input_df.iloc[0]['diameter'], shap_values[1][0][1]\n",
    "            ))\n",
    "\n",
    "# æ·»åŠ è§£é‡Šæ–‡æ¡£\n",
    "with st.expander(\"å¦‚ä½•ä½¿ç”¨æœ¬ç³»ç»Ÿ\"):\n",
    "    st.markdown(\"\"\"\n",
    "    **æ•°æ®è¾“å…¥æŒ‡å—**:\n",
    "    - `age`: æ‚£è€…å¹´é¾„(å²)\n",
    "    - `diameter`: ç—…ç¶ç›´å¾„(mm)\n",
    "    - `SII`: å…¨èº«å…ç–«ç‚ç—‡æŒ‡æ•°\n",
    "    - `enhanced`: æ˜¯å¦å¢å¼ºæ‰«æ(0=å¦,1=æ˜¯)\n",
    "    \"\"\")\n",
    "\n",
    "# è°ƒè¯•ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰\n",
    "st.sidebar.markdown(\"---\")\n",
    "st.sidebar.write(\"æ¨¡å‹ä¿¡æ¯:\")\n",
    "st.sidebar.code(f\"ç‰¹å¾æ•°: {len(feature_names)}\\næœ€ä½³AUC: 0.901\")"
   ]
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "ml",
   "language": "python",
   "name": "ml"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.11.11"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 5
}
