{
 "cells": [
  {
   "cell_type": "code",
   "execution_count": None,
   "id": "996dd449-01ef-46cd-8dd0-ca5d542982a6",
   "metadata": {},
   "outputs": [],
   "source": [
    "import streamlit as st\n",
    "import pandas as pd\n",
    "import numpy as np\n",
    "import joblib\n",
    "import shap\n",
    "import matplotlib.pyplot as plt\n",
    "from io import BytesIO\n",
    "\n",
    "# é¡µé¢è®¾ç½®\n",
    "st.set_page_config(\n",
    "    page_title=\"IDHçªå˜é¢„æµ‹ç³»ç»Ÿ (AdaBoost)\",\n",
    "    layout=\"wide\",\n",
    "    initial_sidebar_state=\"expanded\"\n",
    ")\n",
    "\n",
    "# åŠ è½½æ¨¡å‹\n",
    "@st.cache_resource\n",
    "def load_model():\n",
    "    return joblib.load('best_model.pkl')  # æ›¿æ¢ä¸ºæ‚¨çš„æ¨¡å‹è·¯å¾„\n",
    "\n",
    "model = load_model()\n",
    "\n",
    "# SHAPè§£é‡Šå™¨åˆå§‹åŒ–\n",
    "@st.cache_resource\n",
    "def init_shap():\n",
    "    # ä½¿ç”¨KernelExplainerï¼ˆé€‚é…æ‚¨çš„è®¾ç½®ï¼‰\n",
    "    background = shap.sample(pd.DataFrame(columns=['age', 'diameter', 'SII', 'enhanced', 'FPR', 'lobe', 'symptom', 'edema']), 100)\n",
    "    explainer = shap.KernelExplainer(model.predict_proba, background)\n",
    "    return explainer\n",
    "\n",
    "explainer = init_shap()\n",
    "\n",
    "# ç”¨æˆ·ç•Œé¢\n",
    "st.title('ğŸ§  IDHçªå˜æ¦‚ç‡é¢„æµ‹ç³»ç»Ÿ (AdaBoost)')\n",
    "st.markdown(\"\"\"\n",
    "åŸºäºAdaBoostæ¨¡å‹é¢„æµ‹è„‘è‚¿ç˜¤IDHçªå˜çŠ¶æ€ï¼Œæä¾›SHAPå¯è§£é‡Šæ€§åˆ†æ  \n",
    "*æ³¨ï¼šæ‰€æœ‰è¾“å…¥æ•°æ®ä»…ç”¨äºå®æ—¶è®¡ç®—ï¼Œä¸ä¼šè¢«å­˜å‚¨*\n",
    "\"\"\")\n",
    "\n",
    "# ä¾§è¾¹æ  - è¾“å…¥å‚æ•°\n",
    "st.sidebar.header('å½±åƒç‰¹å¾è¾“å…¥')\n",
    "\n",
    "# åŠ¨æ€ç”Ÿæˆè¾“å…¥å­—æ®µ\n",
    "input_data = {}\n",
    "cols = st.columns(2)\n",
    "\n",
    "with cols[0]:\n",
    "    input_data['age'] = st.number_input(\"å¹´é¾„ï¼ˆå²ï¼‰\", min_value=0, max_value=100, value=45)\n",
    "    input_data['diameter'] = st.number_input(\"è‚¿ç˜¤ç›´å¾„ï¼ˆmmï¼‰\", min_value=0.0, max_value=200.0, value=30.0, step=0.1)\n",
    "    input_data['SII'] = st.number_input(\"SIIæŒ‡æ•°\", min_value=0, max_value=2000, value=600)\n",
    "    input_data['enhanced'] = st.selectbox(\"å¼ºåŒ–ç¨‹åº¦\", options=[\"æ— å¼ºåŒ–\", \"è½»åº¦å¼ºåŒ–\", \"æ˜æ˜¾å¼ºåŒ–\"], index=1)\n",
    "\n",
    "with cols[1]:\n",
    "    input_data['FPR'] = st.number_input(\"FPRå€¼\", min_value=0.0, max_value=2.0, value=0.5, step=0.01)\n",
    "    input_data['lobe'] = st.selectbox(\"è„‘å¶ä½ç½®\", options=[\"é¢å¶\", \"é¢å¶\", \"é¡¶å¶\", \"æ•å¶\", \"å¤šè„‘å¶\"], index=0)\n",
    "    input_data['symptom'] = st.selectbox(\"ä¸´åºŠç—‡çŠ¶\", options=[\"æ— ç—‡çŠ¶\", \"å¤´ç—›\", \"ç™«ç—«\", \"ç¥ç»åŠŸèƒ½éšœç¢\"], index=1)\n",
    "    input_data['edema'] = st.selectbox(\"ç˜¤å‘¨æ°´è‚¿\", options=[\"æ— \", \"è½»åº¦\", \"ä¸­åº¦\", \"é‡åº¦\"], index=1)\n",
    "\n",
    "# é¢„å¤„ç†å‡½æ•°\n",
    "def preprocess_input(input_dict):\n",
    "    # è½¬æ¢åˆ†ç±»å˜é‡\n",
    "    enhanced_map = {\"æ— å¼ºåŒ–\":0, \"è½»åº¦å¼ºåŒ–\":1, \"æ˜æ˜¾å¼ºåŒ–\":2}\n",
    "    lobe_map = {\"é¢å¶\":0, \"é¢å¶\":1, \"é¡¶å¶\":2, \"æ•å¶\":3, \"å¤šè„‘å¶\":4}\n",
    "    symptom_map = {\"æ— ç—‡çŠ¶\":0, \"å¤´ç—›\":1, \"ç™«ç—«\":2, \"ç¥ç»åŠŸèƒ½éšœç¢\":3}\n",
    "    edema_map = {\"æ— \":0, \"è½»åº¦\":1, \"ä¸­åº¦\":2, \"é‡åº¦\":3}\n",
    "    \n",
    "    processed = {\n",
    "        'age': input_dict['age'],\n",
    "        'diameter': input_dict['diameter'],\n",
    "        'SII': input_dict['SII'],\n",
    "        'enhanced': enhanced_map[input_dict['enhanced']],\n",
    "        'FPR': input_dict['FPR'],\n",
    "        'lobe': lobe_map[input_dict['lobe']],\n",
    "        'symptom': symptom_map[input_dict['symptom']],\n",
    "        'edema': edema_map[input_dict['edema']]\n",
    "    }\n",
    "    return pd.DataFrame([processed])\n",
    "\n",
    "# é¢„æµ‹æŒ‰é’®\n",
    "if st.button('é¢„æµ‹IDHçªå˜æ¦‚ç‡'):\n",
    "    # è½¬æ¢ä¸ºDataFrameå¹¶é¢„å¤„ç†\n",
    "    input_df = preprocess_input(input_data)\n",
    "    \n",
    "    # é¢„æµ‹\n",
    "    proba = model.predict_proba(input_df)[0][1]\n",
    "    prediction = \"çªå˜å‹\" if proba >= 0.5 else \"é‡ç”Ÿå‹\"\n",
    "    \n",
    "    # ç»“æœæ˜¾ç¤º\n",
    "    st.success(f\"\"\"\n",
    "    ### é¢„æµ‹ç»“æœ\n",
    "    - **IDHçªå˜æ¦‚ç‡**: {proba:.1%}  \n",
    "    - **é¢„æµ‹ç±»å‹**: {prediction}\n",
    "    - **ä¸´åºŠæ„ä¹‰**: {'å»ºè®®åˆ†å­æ£€æµ‹ç¡®è®¤' if prediction == \"çªå˜å‹\" else 'éœ€è€ƒè™‘å…¶ä»–æ²»ç–—æ–¹æ¡ˆ'}\n",
    "    \"\"\")\n",
    "    \n",
    "    # SHAPè§£é‡Š\n",
    "    st.divider()\n",
    "    st.subheader(\"æ¨¡å‹å†³ç­–è§£é‡Š (SHAP KernelExplainer)\")\n",
    "    \n",
    "    # è®¡ç®—SHAPå€¼\n",
    "    shap_values = explainer.shap_values(input_df)\n",
    "    \n",
    "    # å…¨å±€è§£é‡Š\n",
    "    with st.expander(\"ğŸ“Š ç‰¹å¾é‡è¦æ€§åˆ†æ\", expanded=True):\n",
    "        fig1, ax1 = plt.subplots(figsize=(10, 6))\n",
    "        shap.summary_plot(shap_values, input_df, plot_type=\"bar\", show=False)\n",
    "        plt.title(\"ç‰¹å¾å¯¹é¢„æµ‹çš„æ€»ä½“å½±å“\", pad=20)\n",
    "        st.pyplot(fig1)\n",
    "        plt.close()\n",
    "    \n",
    "    # ä¸ªä½“è§£é‡Š\n",
    "    with st.expander(\"ğŸ” ä¸ªä½“é¢„æµ‹åˆ†è§£\", expanded=True):\n",
    "        fig2 = plt.figure(figsize=(12, 4))\n",
    "        shap.force_plot(\n",
    "            explainer.expected_value[1],  # æ­£ç±»æœŸæœ›å€¼\n",
    "            shap_values[1], \n",
    "            input_df.iloc[0],\n",
    "            matplotlib=True,\n",
    "            show=False\n",
    "        )\n",
    "        plt.title(\"å½“å‰æ ·æœ¬çš„ç‰¹å¾è´¡çŒ®\", pad=10)\n",
    "        st.pyplot(fig2)\n",
    "        plt.close()\n",
    "\n",
    "    # ç‰¹å¾ä¾èµ–åˆ†æ\n",
    "    st.subheader(\"å…³é”®ç‰¹å¾åˆ†æ\")\n",
    "    selected_feat = st.selectbox(\"é€‰æ‹©ç‰¹å¾æŸ¥çœ‹è¯¦ç»†å½±å“\", input_df.columns)\n",
    "    fig3, ax3 = plt.subplots(figsize=(10, 6))\n",
    "    shap.dependence_plot(\n",
    "        selected_feat,\n",
    "        shap_values[1], \n",
    "        input_df,\n",
    "        interaction_index=None,\n",
    "        show=False\n",
    "    )\n",
    "    st.pyplot(fig3)\n",
    "    plt.close()\n",
    "\n",
    "# ç¤ºä¾‹æ•°æ®åŠ è½½\n",
    "with st.sidebar.expander(\"ğŸ’¡ ä½¿ç”¨ç¤ºä¾‹ç—…ä¾‹\"):\n",
    "    if st.button(\"åŠ è½½å…¸å‹çªå˜å‹ç—…ä¾‹\"):\n",
    "        st.session_state.age = 38\n",
    "        st.session_state.diameter = 28.5\n",
    "        st.session_state.SII = 720\n",
    "        st.session_state.enhanced = \"è½»åº¦å¼ºåŒ–\"\n",
    "        st.session_state.FPR = 0.4\n",
    "        st.session_state.lobe = \"é¢å¶\"\n",
    "        st.session_state.symptom = \"ç™«ç—«\"\n",
    "        st.session_state.edema = \"è½»åº¦\"\n",
    "    \n",
    "    if st.button(\"åŠ è½½å…¸å‹é‡ç”Ÿå‹ç—…ä¾‹\"):\n",
    "        st.session_state.age = 62\n",
    "        st.session_state.diameter = 45.0\n",
    "        st.session_state.SII = 980\n",
    "        st.session_state.enhanced = \"æ˜æ˜¾å¼ºåŒ–\"\n",
    "        st.session_state.FPR = 0.8\n",
    "        st.session_state.lobe = \"å¤šè„‘å¶\"\n",
    "        st.session_state.symptom = \"ç¥ç»åŠŸèƒ½éšœç¢\"\n",
    "        st.session_state.edema = \"ä¸­åº¦\"\n",
    "\n",
    "# ä¸´åºŠæŒ‡å—\n",
    "with st.expander(\"â„¹ï¸ IDHä¸´åºŠæ„ä¹‰æŒ‡å—\"):\n",
    "    st.markdown(\"\"\"\n",
    "    **IDHçªå˜å‹ç‰¹å¾**:\n",
    "    - å¸¸è§äºå¹´è½»æ‚£è€…\n",
    "    - è‚¿ç˜¤è¾¹ç•Œè¾ƒæ¸…æ™°\n",
    "    - å¼ºåŒ–ç¨‹åº¦é€šå¸¸è¾ƒè½»\n",
    "    - é¢„åä¼˜äºé‡ç”Ÿå‹\n",
    "    \n",
    "    **æ²»ç–—å»ºè®®**:\n",
    "    - çªå˜å‹ï¼šè€ƒè™‘é¶å‘æ²»ç–—\n",
    "    - é‡ç”Ÿå‹ï¼šä¼˜å…ˆæ”¾åŒ–ç–—è”åˆæ–¹æ¡ˆ\n",
    "    \"\"\")\n",
    "\n",
    "# æŠ€æœ¯è¯´æ˜\n",
    "st.sidebar.markdown(\"\"\"\n",
    "**æŠ€æœ¯å‚æ•°**:\n",
    "- æ¨¡å‹ç±»å‹: AdaBoost\n",
    "- ç‰¹å¾æ•°: 8\n",
    "- SHAPè§£é‡Šå™¨: KernelExplainer\n",
    "\"\"\")"
   ]
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "ml",
   "language": "python",
   "name": "ml"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.11.11"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 5
}
